---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getCollection } from 'astro:content';
import { excerptFrom } from "../lib/content";
import { RIVERS } from "../content/rivers";

// Get river filter from query params
const riverFilter = Astro.url.searchParams.get('river');

// Get all published posts, sorted chronologically (newest first)
let allPosts = (await getCollection('journal'))
  .filter(p => p.data.status !== 'draft')
  .sort((a,b) => +b.data.date - +a.data.date);

// Filter by river if specified
const posts = riverFilter && riverFilter !== 'all'
  ? allPosts.filter(p => p.data.river === riverFilter)
  : allPosts;

const PAGE_SIZE = 10;
const displayPosts = posts.slice(0, PAGE_SIZE);
const hasMore = posts.length > PAGE_SIZE;
---
<BaseLayout activeNav="FEED">
  <main id="main" class="content-feed">
    <div class="feed-inner">
      <div class="announcement sticky">
        <div class="announcement-text">
          {riverFilter && riverFilter !== 'all'
            ? `${RIVERS[riverFilter as keyof typeof RIVERS].label.toUpperCase()} // RIVER`
            : 'COHERENCEISM BLOG'}
        </div>
      </div>

      <div class="feed-list">
      {displayPosts.map(post => {
        const ex = post.data.excerpt || excerptFrom(post.body);
        return (
        <article class="feed-post" style={`--rcolor:${RIVERS[post.data.river].color}`} data-river={post.data.river}>
          <div class="post-header">
            <div class="post-meta">
              <span class="post-date">{post.data.date.toISOString().slice(0,10)}</span>
              <span class="river-chip" style={`color:${RIVERS[post.data.river].color}`}>
                {RIVERS[post.data.river].label}
              </span>
            </div>
            <h2 class="post-title">{post.data.title}</h2>
          </div>
          {ex && <p class="post-excerpt">{ex}</p>}
          <div class="post-footer">
            <a href={`/journal/${post.slug}`} class="read-more">READ ▸</a>
          </div>
        </article>
      )})}
      </div>

      {hasMore && (
        <div class="feed-load-more">
          <a class="read-more" href="/page/2">Load more posts ▸</a>
        </div>
      )}
    </div>
  </main>
</BaseLayout>
